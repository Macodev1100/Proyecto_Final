@model P_F.ViewModels.ReporteProductividadViewModel

@{
    ViewData["Title"] = "Productividad de Empleados";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-users-cog me-2"></i>@ViewData["Title"]
                    </h1>
                    <p class="mb-0 text-muted">Análisis de rendimiento y productividad por empleado</p>
                </div>
                <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Volver
                </a>
            </div>

            <!-- Filtros -->
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-filter me-2"></i>Filtros de Período
                    </h6>
                </div>
                <div class="card-body">
                    <form method="get">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="fechaInicio" class="form-label">Fecha Inicio</label>
                                    <input type="date" name="fechaInicio" id="fechaInicio" class="form-control" value="@Model?.FechaInicio?.ToString("yyyy-MM-dd")" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="fechaFin" class="form-label">Fecha Fin</label>
                                    <input type="date" name="fechaFin" id="fechaFin" class="form-control" value="@Model?.FechaFin?.ToString("yyyy-MM-dd")" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-search me-1"></i>Generar Reporte
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Resumen General -->
            <div class="row mb-4">
                <div class="col-xl-6 col-md-6 mb-4">
                    <div class="card border-left-primary shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                        Total Ingresos Período</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                        Q @((Model?.TotalIngresosPeriodo ?? 0).ToString("N2"))
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-6 col-md-6 mb-4">
                    <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                        Órdenes Completadas</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                        @(Model?.TotalOrdenesPeriodo ?? 0)
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de Productividad -->
            @if (Model?.EmpleadosProductividad != null && Model.EmpleadosProductividad.Any())
            {
                <div class="card shadow">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-chart-bar me-2"></i>Productividad por Empleado
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Empleado</th>
                                        <th>Especialidad</th>
                                        <th>Órdenes Completadas</th>
                                        <th>Órdenes En Proceso</th>
                                        <th>Total Ingresos</th>
                                        <th>Promedio por Orden</th>
                                        <th>Eficiencia</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var empleado in Model.EmpleadosProductividad.OrderByDescending(e => e.TotalIngresos))
                                    {
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-user-circle fa-2x text-gray-300 me-2"></i>
                                                    <div>
                                                        <div class="font-weight-bold">@empleado.NombreCompleto</div>
                                                        <div class="small text-gray-500">ID: @empleado.EmpleadoId</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge badge-info">@empleado.Especialidad</span>
                                            </td>
                                            <td>
                                                <span class="badge badge-success">@empleado.OrdenesCompletadas</span>
                                            </td>
                                            <td>
                                                <span class="badge badge-warning">@empleado.OrdenesEnProceso</span>
                                            </td>
                                            <td>
                                                <div class="font-weight-bold text-success">
                                                    Q @empleado.TotalIngresos.ToString("N2")
                                                </div>
                                            </td>
                                            <td>
                                                @if (empleado.OrdenesCompletadas > 0)
                                                {
                                                    <span>Q @((empleado.TotalIngresos / empleado.OrdenesCompletadas).ToString("N2"))</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">N/A</span>
                                                }
                                            </td>
                                            <td>
                                                @{
                                                    var eficienciaClass = empleado.EficienciaCalculada >= 80 ? "success" : 
                                                                         empleado.EficienciaCalculada >= 60 ? "warning" : "danger";
                                                }
                                                <span class="badge badge-@eficienciaClass">
                                                    @empleado.EficienciaCalculada.ToString("F1")%
                                                </span>
                                            </td>
                                            <td>
                                                <a asp-controller="Empleados" asp-action="Details" asp-route-id="@empleado.EmpleadoId" 
                                                   class="btn btn-info btn-sm" title="Ver Detalles">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a asp-controller="Empleados" asp-action="Productividad" asp-route-id="@empleado.EmpleadoId" 
                                                   class="btn btn-primary btn-sm" title="Ver Productividad Individual">
                                                    <i class="fas fa-chart-line"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de Productividad -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="fas fa-chart-pie me-2"></i>Distribución de Ingresos por Empleado
                                </h6>
                            </div>
                            <div class="card-body">
                                <canvas id="productividadChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card shadow">
                    <div class="card-body text-center">
                        <i class="fas fa-user-times fa-3x text-gray-300 mb-3"></i>
                        <h5>No hay datos de productividad</h5>
                        <p class="text-muted">No se encontraron datos de productividad para el período seleccionado.</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Configurar gráfico de productividad
        @if (Model?.EmpleadosProductividad != null && Model.EmpleadosProductividad.Any())
        {
            <text>
                var ctx = document.getElementById('productividadChart').getContext('2d');
                var empleados = @Html.Raw(Json.Serialize(Model.EmpleadosProductividad.Take(10).Select(e => e.NombreCompleto)));
                var ingresos = @Html.Raw(Json.Serialize(Model.EmpleadosProductividad.Take(10).Select(e => e.TotalIngresos)));

                var productividadChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: empleados,
                        datasets: [{
                            data: ingresos,
                            backgroundColor: [
                                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
                                '#858796', '#5a5c69', '#6f42c1', '#e83e8c', '#fd7e14'
                            ],
                            hoverBackgroundColor: [
                                '#2e59d9', '#17a673', '#2c9faf', '#dda20a', '#c0392b',
                                '#717384', '#484a56', '#5a32a3', '#c42364', '#d63384'
                            ],
                            hoverBorderColor: "rgba(234, 236, 244, 1)",
                        }],
                    },
                    options: {
                        maintainAspectRatio: false,
                        tooltips: {
                            backgroundColor: "rgb(255,255,255)",
                            bodyFontColor: "#858796",
                            borderColor: '#dddfeb',
                            borderWidth: 1,
                            xPadding: 15,
                            yPadding: 15,
                            displayColors: false,
                            caretPadding: 10,
                            callbacks: {
                                label: function(tooltipItem, chart) {
                                    var dataLabel = chart.labels[tooltipItem.index];
                                    var value = chart.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                                    return dataLabel + ': Q' + value.toFixed(2);
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        cutoutPercentage: 80,
                    },
                });
            </text>
        }
    </script>
}