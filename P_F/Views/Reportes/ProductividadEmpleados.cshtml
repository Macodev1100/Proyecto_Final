@model P_F.ViewModels.ReporteProductividadViewModel

@{
    ViewData["Title"] = "Productividad de Empleados";
}

<!-- Incluir Chart.js y librerías adicionales -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<div class="container-fluid px-4">
    <!-- Header del Reporte -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-sm-flex align-items-center justify-content-between mb-4">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-users-cog text-primary me-2"></i>@ViewData["Title"]
                    </h1>
                    <p class="text-muted mb-0">Análisis detallado del rendimiento y productividad del equipo técnico</p>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportarReporte()">
                        <i class="fas fa-download"></i> Exportar PDF
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="exportarExcel()">
                        <i class="fas fa-file-excel"></i> Exportar Excel
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="location.reload()">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                    <a asp-controller="Home" asp-action="Index" class="btn btn-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>Volver
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros Avanzados -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-gradient-primary text-white">
            <div class="d-flex align-items-center">
                <i class="fas fa-filter me-2"></i>
                <h6 class="mb-0">Filtros de Análisis</h6>
                <button class="btn btn-sm btn-outline-light ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosCollapse">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
        </div>
        <div class="collapse show" id="filtrosCollapse">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label for="tipoEmpleado" class="form-label">Tipo de Empleado</label>
                        <select class="form-select" id="tipoEmpleado" name="tipoEmpleado">
                            <option value="">Todos</option>
                            <option value="Mecanico">Mecánicos</option>
                            <option value="Supervisor">Supervisores</option>
                            <option value="Administrador">Administradores</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="fechaInicio" class="form-label">Fecha Inicio</label>
                        <input type="date" class="form-control" id="fechaInicio" name="fechaInicio" value="@Model?.FechaInicio?.ToString("yyyy-MM-dd")">
                    </div>
                    <div class="col-md-3">
                        <label for="fechaFin" class="form-label">Fecha Fin</label>
                        <input type="date" class="form-control" id="fechaFin" name="fechaFin" value="@Model?.FechaFin?.ToString("yyyy-MM-dd")">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary flex-fill">
                                <i class="fas fa-search"></i> Aplicar Filtros
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Métricas Principales -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow-sm h-100 metric-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Ingresos Período
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800 counter-value" data-target="@((int)(Model?.TotalIngresosPeriodo ?? 0))">
                                @(Model != null && Model.TotalIngresosPeriodo > 0 ? "$" + Model.TotalIngresosPeriodo.ToString("N2") : "Sin datos")
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow-sm h-100 metric-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Órdenes Completadas
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800 counter-value" data-target="@(Model?.TotalOrdenesPeriodo ?? 0)">
                                @(Model != null && Model.TotalOrdenesPeriodo > 0 ? Model.TotalOrdenesPeriodo.ToString() : "Sin datos")
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow-sm h-100 metric-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Total Empleados
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800 counter-value" data-target="@(Model?.EmpleadosProductividad?.Count() ?? 0)">
                                @(Model != null && Model.EmpleadosProductividad != null && Model.EmpleadosProductividad.Count() > 0 ? Model.EmpleadosProductividad.Count().ToString() : "Sin datos")
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow-sm h-100 metric-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Total Horas Trabajadas
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @(Model != null && Model.EmpleadosProductividad != null && Model.EmpleadosProductividad.Sum(e => e.HorasTrabajadas) > 0
                                    ? Model.EmpleadosProductividad.Sum(e => e.HorasTrabajadas).ToString("N2") + " h"
                                    : "Sin datos")
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos de Productividad -->

    @if (Model?.EmpleadosProductividad != null && Model.EmpleadosProductividad.Any())
    {
        <div class="row mb-4">
            <!-- Gráfico de Ingresos por Empleado -->
            <div class="col-xl-8 col-lg-7">
                <div class="card shadow-sm mb-4">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-chart-bar me-2"></i>Ingresos por Empleado
                        </h6>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-cog"></i> Opciones
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="cambiarTipoGrafico('bar')">Gráfico de Barras</a></li>
                                <li><a class="dropdown-item" href="#" onclick="cambiarTipoGrafico('line')">Gráfico de Líneas</a></li>
                                <li><a class="dropdown-item" href="#" onclick="cambiarTipoGrafico('radar')">Gráfico Radar</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="position: relative; height: 400px;">
                            <canvas id="ingresosChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Distribución de Ingresos -->
            <div class="col-xl-4 col-lg-5">
                <div class="card shadow-sm mb-4">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-table me-2"></i>Detalle de Productividad por Empleado
                            </h6>
                            <div class="input-group" style="max-width: 300px;">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="buscarEmpleado" placeholder="Buscar empleado...">
                            </div>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <!-- Aquí puedes agregar el gráfico de distribución y la tabla de empleados si aplica -->
                        <canvas id="distribucionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- Tabla detallada de productividad por empleado -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header py-3 d-flex align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-users me-2"></i>Resumen Detallado por Empleado
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Empleado</th>
                                        <th>Especialidad</th>
                                        <th>Órdenes Completadas</th>
                                        <th>Ingresos</th>
                                        <th>Eficiencia (%)</th>
                                        <th>Horas Trabajadas</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var emp in Model.EmpleadosProductividad)
                                    {
                                        <tr class="empleado-row" data-nombre="@emp.NombreCompleto.ToLower()">
                                            <td>@emp.NombreCompleto</td>
                                            <td>@emp.Especialidad</td>
                                            <td>@(emp.OrdenesCompletadas > 0 ? emp.OrdenesCompletadas.ToString() : "Sin datos")</td>
                                            <td>@(emp.TotalIngresos > 0 ? "$" + emp.TotalIngresos.ToString("N2") : "Sin datos")</td>
                                            <td>@(emp.EficienciaCalculada > 0 ? emp.EficienciaCalculada.ToString("N2") : "Sin datos")</td>
                                            <td>@(emp.HorasTrabajadas > 0 ? emp.HorasTrabajadas.ToString("N2") + " h" : "Sin datos")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-bullseye me-2"></i>Eficiencia de Empleados
                        </h6>
                    </div>
                    <div class="card-body">
                        <div style="position: relative; height: 400px;">
                            <canvas id="eficienciaChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row mb-4">
            <div class="col-12 text-center text-muted py-5">Sin datos de productividad</div>
        </div>
    }

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            inicializarContadores();
            @if (Model?.EmpleadosProductividad != null && Model.EmpleadosProductividad.Any())
            {
                <text>
                    inicializarGraficoIngresos();
                    inicializarGraficoDistribucion();
                    inicializarGraficoEficiencia();
                </text>
            }
            configurarBusqueda();
        });

        function inicializarContadores() {
            const counters = document.querySelectorAll('.counter-value');
            counters.forEach(counter => {
                const target = parseInt(counter.getAttribute('data-target')) || 0;
                let current = 0;
                const increment = target / 50;
                
                if (counter.textContent.includes('$')) {
                    const timer = setInterval(() => {
                        current += increment;
                        if (current >= target) {
                            current = target;
                            clearInterval(timer);
                        }
                        counter.textContent = '$' + Math.floor(current).toLocaleString();
                    }, 40);
                } else {
                    const timer = setInterval(() => {
                        current += increment;
                        if (current >= target) {
                            current = target;
                            clearInterval(timer);
                        }
                        counter.textContent = Math.floor(current);
                    }, 40);
                }
            });
        }

        @if (Model?.EmpleadosProductividad != null && Model.EmpleadosProductividad.Any())
        {
            <text>
                function inicializarGraficoIngresos() {
                    const ctx = document.getElementById('ingresosChart').getContext('2d');
                    
                    const empleadosData = @Html.Raw(Json.Serialize(Model.EmpleadosProductividad.Take(10).Select(e => new {
                        nombre = e.NombreCompleto.Split(' ')[0],
                        ingresos = e.TotalIngresos,
                        ordenes = e.OrdenesCompletadas
                    })));
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: empleadosData.map(e => e.nombre),
                            datasets: [{
                                label: 'Ingresos ($)',
                                data: empleadosData.map(e => e.ingresos),
                                backgroundColor: 'rgba(78, 115, 223, 0.8)',
                                borderColor: 'rgba(78, 115, 223, 1)',
                                borderWidth: 2,
                                borderRadius: 5,
                                borderSkipped: false,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'top' },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    callbacks: {
                                        label: function(context) {
                                            return 'Ingresos: $' + context.parsed.y.toLocaleString();
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { 
                                    grid: { display: false },
                                    ticks: { color: '#858796' }
                                },
                                y: { 
                                    beginAtZero: true, 
                                    grid: { color: 'rgba(0,0,0,0.1)' },
                                    ticks: { 
                                        color: '#858796',
                                        callback: function(value) {
                                            return '$' + value.toLocaleString();
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                function inicializarGraficoDistribucion() {
                    const ctx = document.getElementById('distribucionChart').getContext('2d');
                    
                    const empleadosData = @Html.Raw(Json.Serialize(Model.EmpleadosProductividad.Take(8).Select(e => new {
                        nombre = e.NombreCompleto.Split(' ')[0],
                        ingresos = e.TotalIngresos
                    })));
                    
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: empleadosData.map(e => e.nombre),
                            datasets: [{
                                data: empleadosData.map(e => e.ingresos),
                                backgroundColor: [
                                    '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
                                    '#858796', '#5a5c69', '#f8f9fc'
                                ],
                                borderWidth: 3,
                                borderColor: '#fff',
                                hoverBorderWidth: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    position: 'bottom', 
                                    labels: { 
                                        padding: 20, 
                                        usePointStyle: true,
                                        color: '#5a5c69'
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                                            return context.label + ': $' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                        }
                                    }
                                }
                            },
                            cutout: '60%'
                        }
                    });
                }

                function inicializarGraficoEficiencia() {
                    const ctx = document.getElementById('eficienciaChart').getContext('2d');
                    
                    const empleadosData = @Html.Raw(Json.Serialize(Model.EmpleadosProductividad.Select(e => new {
                        nombre = e.NombreCompleto.Split(' ')[0],
                        eficiencia = e.EficienciaCalculada,
                        ordenes = e.OrdenesCompletadas,
                        ingresos = e.TotalIngresos
                    })));
                    
                    new Chart(ctx, {
                        type: 'bubble',
                        data: {
                            datasets: [{
                                label: 'Empleados',
                                data: empleadosData.map(e => ({
                                    x: e.ordenes,
                                    y: e.eficiencia,
                                    r: Math.sqrt(e.ingresos) / 50
                                })),
                                backgroundColor: empleadosData.map(e => 
                                    e.eficiencia >= 80 ? 'rgba(28, 200, 138, 0.6)' :
                                    e.eficiencia >= 60 ? 'rgba(246, 194, 62, 0.6)' : 
                                    'rgba(231, 74, 59, 0.6)'
                                ),
                                borderColor: empleadosData.map(e => 
                                    e.eficiencia >= 80 ? 'rgba(28, 200, 138, 1)' :
                                    e.eficiencia >= 60 ? 'rgba(246, 194, 62, 1)' : 
                                    'rgba(231, 74, 59, 1)'
                                ),
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        title: function(context) {
                                            const index = context[0].dataIndex;
                                            return empleadosData[index].nombre;
                                        },
                                        label: function(context) {
                                            const index = context.dataIndex;
                                            const data = empleadosData[index];
                                            return [
                                                'Órdenes: ' + data.ordenes,
                                                'Eficiencia: ' + data.eficiencia.toFixed(1) + '%',
                                                'Ingresos: $' + data.ingresos.toLocaleString()
                                            ];
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Órdenes Completadas',
                                        color: '#5a5c69'
                                    },
                                    grid: { color: 'rgba(0,0,0,0.1)' },
                                    ticks: { color: '#858796' }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Eficiencia (%)',
                                        color: '#5a5c69'
                                    },
                                    grid: { color: 'rgba(0,0,0,0.1)' },
                                    ticks: { 
                                        color: '#858796',
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            </text>
        }

        function configurarBusqueda() {
            const buscarInput = document.getElementById('buscarEmpleado');
            if (buscarInput) {
                buscarInput.addEventListener('keyup', function() {
                    const filtro = this.value.toLowerCase();
                    const filas = document.querySelectorAll('.empleado-row');
                    
                    filas.forEach(fila => {
                        const nombre = fila.getAttribute('data-nombre');
                        if (nombre && nombre.includes(filtro)) {
                            fila.style.display = '';
                        } else {
                            fila.style.display = 'none';
                        }
                    });
                });
            }
        }

        function ordenarTabla(columna) {
            console.log('Ordenando por:', columna);
            // Implementar ordenamiento por columna
        }

        function verDetalle(empleadoId) {
            document.getElementById('modalDetalleContent').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('modalDetalle'));
            modal.show();
            
            setTimeout(() => {
                document.getElementById('modalDetalleContent').innerHTML = `
                    <div class="row">
                        <div class="col-12">
                            <h6>Detalle del Empleado ${empleadoId}</h6>
                            <p>Aquí se mostraría información detallada sobre la productividad, historial de trabajos, etc.</p>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Esta funcionalidad puede expandirse para mostrar gráficos detallados, historial de órdenes, comentarios de clientes, etc.
                            </div>
                        </div>
                    </div>
                `;
            }, 1000);
        }

        function exportarReporte() {
            console.log('Exportando reporte a PDF...');
            alert('Funcionalidad de exportación en desarrollo');
        }

        function exportarExcel() {
            console.log('Exportando a Excel...');
            alert('Funcionalidad de exportación en desarrollo');
        }

        function generarReporteIndividual(empleadoId) {
            console.log('Generando reporte individual para empleado:', empleadoId);
            alert('Funcionalidad en desarrollo - Reporte individual para empleado ' + empleadoId);
        }

        function limpiarFiltros() {
            document.getElementById('tipoEmpleado').selectedIndex = 0;
            document.getElementById('fechaInicio').value = '';
            document.getElementById('fechaFin').value = '';
        }

        function cambiarTipoGrafico(tipo) {
            console.log('Cambiando tipo de gráfico a:', tipo);
            alert('Funcionalidad en desarrollo - Cambiar a gráfico ' + tipo);
        }
    </script>
}