@model IEnumerable<dynamic>

@{
    ViewData["Title"] = "Clientes Frecuentes";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-users me-2"></i>@ViewData["Title"]
                    </h1>
                    <p class="mb-0 text-muted">Análisis de clientes más frecuentes y su actividad</p>
                </div>
                <div class="d-flex gap-2">
                    <a asp-action="ClientesFrecuentesPdf" class="btn btn-danger">
                        <i class="fas fa-file-pdf me-1"></i>Exportar PDF
                    </a>
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Volver
                    </a>
                </div>
            </div>

            <!-- Filtros -->
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-filter me-2"></i>Filtros de Período
                    </h6>
                </div>
                <div class="card-body">
                    <form method="get">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="mes">Mes</label>
                                    <select name="mes" id="mes" class="form-control">
                                        <option value="1" selected="@(DateTime.Now.Month == 1)">Enero</option>
                                        <option value="2" selected="@(DateTime.Now.Month == 2)">Febrero</option>
                                        <option value="3" selected="@(DateTime.Now.Month == 3)">Marzo</option>
                                        <option value="4" selected="@(DateTime.Now.Month == 4)">Abril</option>
                                        <option value="5" selected="@(DateTime.Now.Month == 5)">Mayo</option>
                                        <option value="6" selected="@(DateTime.Now.Month == 6)">Junio</option>
                                        <option value="7" selected="@(DateTime.Now.Month == 7)">Julio</option>
                                        <option value="8" selected="@(DateTime.Now.Month == 8)">Agosto</option>
                                        <option value="9" selected="@(DateTime.Now.Month == 9)">Septiembre</option>
                                        <option value="10" selected="@(DateTime.Now.Month == 10)">Octubre</option>
                                        <option value="11" selected="@(DateTime.Now.Month == 11)">Noviembre</option>
                                        <option value="12" selected="@(DateTime.Now.Month == 12)">Diciembre</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="año">Año</label>
                                    <select name="año" id="año" class="form-control">
                                        @for (int year = DateTime.Now.Year - 2; year <= DateTime.Now.Year + 1; year++)
                                        {
                                            <option value="@year" selected="@(year == DateTime.Now.Year)">@year</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-search me-1"></i>Filtrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Estadísticas generales -->
            <div class="row mb-4">
                @if (Model != null && Model.Any())
                {
                    <!-- Aquí puedes agregar tarjetas de métricas reales si existen -->
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-primary shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                            Cliente Frecuente
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                                            @{
                                                var primerCliente = (Model != null && Model.Any()) ? Model.FirstOrDefault() : null;
                                                var nombreProp = primerCliente?.GetType().GetProperty("Nombre");
                                                var nombreValor = nombreProp != null ? nombreProp.GetValue(primerCliente) as string : null;
                                            }
                                            @(string.IsNullOrEmpty(nombreValor) ? "Sin datos" : nombreValor)
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-users fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="col-12 text-center text-muted py-5">Sin datos de clientes frecuentes</div>
                }

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                        Facturación Total</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                        @{
                                            decimal? totalFacturado = (Model != null && Model.Any()) ? Model.Sum(c => (decimal?)c.TotalFacturado) : null;
                                        }
                                        @(totalFacturado.HasValue && totalFacturado.Value > 0 ? "$" + totalFacturado.Value.ToString("N2") : "Sin datos")
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                        Promedio por Cliente</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                        @{
                                            decimal? totalFacturadoProm = (Model != null && Model.Any()) ? Model.Sum(c => (decimal?)c.TotalFacturado) : null;
                                            int? totalOrdenesProm = (Model != null && Model.Any()) ? Model.Sum(c => (int?)c.TotalOrdenes) : null;
                                        }
                                        @(totalFacturadoProm.HasValue && totalFacturadoProm.Value > 0 && totalOrdenesProm.HasValue && totalOrdenesProm.Value > 0 ? "$" + (totalFacturadoProm.Value / totalOrdenesProm.Value).ToString("N2") : "Sin datos")
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de clientes frecuentes -->
            @if (Model != null && Model.Any())
            {
                <div class="card shadow">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-star me-2"></i>Top 20 Clientes Más Frecuentes
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Posición</th>
                                        <th>Cliente</th>
                                        <th>Contacto</th>
                                        <th>Total Órdenes</th>
                                        <th>Total Facturado</th>
                                        <th>Última Visita</th>
                                        <th>Promedio por Orden</th>
                                        <th>Frecuencia</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        int posicion = 1;
                                    }
                                    @foreach (var cliente in Model)
                                    {
                                        <tr>
                                            <td>
                                                @if (posicion <= 3)
                                                {
                                                    <span class="badge badge-@(posicion == 1 ? "warning" : posicion == 2 ? "secondary" : "info")">
                                                        @posicion°
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">@posicion°</span>
                                                }
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-3">
                                                        <i class="fas fa-user text-white"></i>
                                                    </div>
                                                    <div>
                                                        <div class="font-weight-bold">@((cliente.Cliente != null && !string.IsNullOrEmpty(cliente.Cliente.Nombre)) ? cliente.Cliente.Nombre : "Sin datos") @((cliente.Cliente != null && !string.IsNullOrEmpty(cliente.Cliente.Apellido)) ? cliente.Cliente.Apellido : "")</div>
                                                        <div class="small text-gray-500">ID: @(cliente.Cliente != null ? cliente.Cliente.ClienteId.ToString() : "Sin datos")</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div>
                                                    @if (!string.IsNullOrEmpty(cliente.Cliente.Telefono))
                                                    {
                                                        <div><i class="fas fa-phone text-muted me-1"></i>@(cliente.Cliente != null && !string.IsNullOrEmpty(cliente.Cliente.Telefono) ? cliente.Cliente.Telefono : "Sin datos")</div>
                                                    }
                                                    @if (!string.IsNullOrEmpty(cliente.Cliente.Email))
                                                    {
                                                        <div><i class="fas fa-envelope text-muted me-1"></i>@(cliente.Cliente != null && !string.IsNullOrEmpty(cliente.Cliente.Email) ? cliente.Cliente.Email : "Sin datos")</div>
                                                    }
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge badge-primary font-size-12">
                                                    @(cliente.TotalOrdenes > 0 ? cliente.TotalOrdenes.ToString() + " órdenes" : "Sin datos")
                                                </span>
                                            </td>
                                            <td>
                                                <div class="font-weight-bold text-success">
                                                    @(cliente.TotalFacturado > 0 ? "$" + cliente.TotalFacturado.ToString("N2") : "Sin datos")
                                                </div>
                                            </td>
                                            <td>
                                                @if (cliente.UltimaVisita != default(DateTime))
                                                {
                                                    <div>@cliente.UltimaVisita.ToString("dd/MM/yyyy")</div>
                                                    <small class="text-muted">
                                                        @{
                                                            var diasDesdeVisita = (DateTime.Now - cliente.UltimaVisita).Days;
                                                        }
                                                        @(diasDesdeVisita == 0 ? "Hoy" : diasDesdeVisita == 1 ? "Ayer" : $"Hace {diasDesdeVisita} días")
                                                    </small>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Sin visitas</span>
                                                }
                                            </td>
                                            <td>
                                                @(cliente.TotalFacturado > 0 && cliente.TotalOrdenes > 0 ? "$" + (cliente.TotalFacturado / cliente.TotalOrdenes).ToString("N2") : "Sin datos")
                                            </td>
                                            <td>
                                                @{
                                                    var frecuencia = cliente.TotalOrdenes >= 10 ? "Muy Alta" :
                                                                   cliente.TotalOrdenes >= 5 ? "Alta" :
                                                                   cliente.TotalOrdenes >= 3 ? "Media" : "Baja";
                                                    var badgeClass = cliente.TotalOrdenes >= 10 ? "success" :
                                                                   cliente.TotalOrdenes >= 5 ? "warning" :
                                                                   cliente.TotalOrdenes >= 3 ? "info" : "secondary";
                                                }
                                                <span class="badge badge-@badgeClass">@frecuencia</span>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a asp-controller="Clientes" asp-action="Details" asp-route-id="@cliente.Cliente.ClienteId" 
                                                       class="btn btn-info btn-sm" title="Ver Detalles">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <a asp-controller="OrdenesTrabajo" asp-action="Create" asp-route-clienteId="@cliente.Cliente.ClienteId" 
                                                       class="btn btn-primary btn-sm" title="Nueva Orden">
                                                        <i class="fas fa-plus"></i>
                                                    </a>
                                                    <a asp-controller="Facturas" asp-action="Create" asp-route-clienteId="@cliente.Cliente.ClienteId" 
                                                       class="btn btn-success btn-sm" title="Nueva Factura">
                                                        <i class="fas fa-file-invoice"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        }
                                    @{ posicion++; }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de distribución -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="fas fa-chart-pie me-2"></i>Distribución de Facturación por Cliente
                                </h6>
                            </div>
                            <div class="card-body">
                                <canvas id="clientesChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card shadow">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-user-slash fa-5x text-gray-300 mb-4"></i>
                        <h3>No hay clientes frecuentes</h3>
                        <p class="text-muted">No se encontraron clientes con actividad en el período seleccionado.</p>
                        <a asp-controller="Clientes" asp-action="Index" class="btn btn-primary mt-3">
                            <i class="fas fa-users me-2"></i>Ver Todos los Clientes
                        </a>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Configurar valores seleccionados
        $(document).ready(function() {
            const mesActual = @ViewBag.Mes;
            const añoActual = @ViewBag.Año;
            
            $('#mes').val(mesActual);
            $('#año').val(añoActual);

            // Inicializar DataTable
            $('#dataTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json"
                },
                "order": [[3, "desc"]], // Ordenar por total órdenes
                "pageLength": 20,
                "columnDefs": [
                    {
                        "targets": [4, 6], // Columnas de montos
                        "className": "text-right"
                    },
                    {
                        "targets": [8], // Columna de acciones
                        "orderable": false
                    }
                ]
            });
        });

        // Configurar gráfico de clientes
        @if (Model != null && Model.Any())
        {
            <text>
                var ctx = document.getElementById('clientesChart').getContext('2d');
                var clientes = ['Cliente 1', 'Cliente 2', 'Cliente 3', 'Cliente 4', 'Cliente 5'];
                var facturacion = [1000, 800, 600, 400, 200];

                var clientesChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: clientes,
                        datasets: [{
                            data: facturacion,
                            backgroundColor: [
                                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
                                '#858796', '#5a5c69', '#6f42c1', '#e83e8c', '#fd7e14'
                            ],
                            hoverBackgroundColor: [
                                '#2e59d9', '#17a673', '#2c9faf', '#dda20a', '#c0392b',
                                '#717384', '#484a56', '#5a32a3', '#c42364', '#d63384'
                            ],
                        }],
                    },
                    options: {
                        maintainAspectRatio: false,
                        tooltips: {
                            backgroundColor: "rgb(255,255,255)",
                            bodyFontColor: "#858796",
                            borderColor: '#dddfeb',
                            borderWidth: 1,
                            callbacks: {
                                label: function(tooltipItem, chart) {
                                    var dataLabel = chart.labels[tooltipItem.index];
                                    var value = chart.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                                    return dataLabel + ': $' + value.toFixed(2);
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        cutoutPercentage: 80,
                    },
                });
            </text>
        }
    </script>
}